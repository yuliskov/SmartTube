name: VirusTotal Quick Scan on Release

on:
  release:
    types: [published]

jobs:
  virustotal_scan:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y jq curl

      - name: Download Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p release_assets
          gh release download ${{ github.event.release.tag_name }} --dir release_assets --pattern "*.apk"
          ls -l release_assets

      - name: Install VirusTotal CLI
        run: |
          curl -L https://github.com/VirusTotal/vt-cli/releases/download/1.2.0/Linux64.zip -o vt-cli.zip
          unzip vt-cli.zip
          sudo mv vt /usr/local/bin/

      - name: Scan APKs and Generate Quick Report
        env:
          VT_API_KEY: ${{ secrets.VIRUS_TOTAL_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ›¡ï¸ VirusTotal Scan Results:" > vt_report.txt

          for apk in release_assets/*.apk; do
            echo "Scanning $apk..."
            scan_id=$(vt file scan "$apk" --apikey $VT_API_KEY --json | jq -r '.data.id')

            # Ð‘Ñ‹ÑÑ‚Ñ€Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð°Ð½Ð°Ð»Ð¸Ð· (Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹)
            sleep 15
            malicious=$(vt analysis report "$scan_id" --apikey $VT_API_KEY --json | jq -r '.data.attributes.stats.malicious')

            if [ "$malicious" -gt 0 ]; then
              echo "$apk â€” BAD âŒ" >> vt_report.txt
            else
              echo "$apk â€” OK âœ…" >> vt_report.txt
            fi
          done

      - name: Update Release with Quick Report
        run: |
          gh release edit ${{ github.event.release.tag_name }} --add-body-file vt_report.txt

      - name: Done
        run: echo "VirusTotal quick scan finished and report added to release."
