name: VirusTotal Quick Scan for Release Draft

on: workflow_dispatch

jobs:
  virustotal_scan:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt update && sudo apt install -y jq curl

      - name: Download Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release list --limit 1 --json tagName -q .[0].tagName > release_tag.txt
          tag=$(cat release_tag.txt)
          echo "Downloading release tag $tag"
          mkdir -p release_assets
          gh release download "$tag" --dir release_assets --pattern "*.apk"
          ls -l release_assets

      - name: Install VirusTotal CLI
        run: |
          curl -L https://github.com/VirusTotal/vt-cli/releases/download/1.2.0/Linux64.zip -o vt-cli.zip
          unzip vt-cli.zip
          sudo mv vt /usr/local/bin/

      - name: Scan APKs and Generate Quick Report
        env:
          VT_API_KEY: ${{ secrets.VIRUS_TOTAL_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ›¡ï¸ VirusTotal Scan Results:" > vt_report.txt

          for apk in release_assets/*.apk; do
            filename=$(basename "$apk")
            sha256=$(sha256sum "$apk" | head -c 64)
            echo "Scanning $filename..."
            
            scan_id=$(vt scan file "$apk" -k $VT_API_KEY | awk '{print $2}')
            echo "Scan ID: $scan_id"

            for i in {1..15}; do
              sleep 15
              analysis_json=$(vt analysis report "$scan_id" -k $VT_API_KEY --format json)
              status=$(echo "$analysis_json" | jq -r '.[0].status')
              malicious=$(echo "$analysis_json" | jq '.[0].stats.malicious')
              if [ "$status" == "completed" ]; then
                break
              fi
            done

            if [ "$status" != "completed" ]; then
              echo " - [![VT](https://badges.cssnr.com/vt/id/$sha256) $filename](https://www.virustotal.com/gui/file/$sha256) â€” BAD âŒ (analysis incomplete)" >> vt_report.txt
            elif [ "$malicious" -gt 0 ]; then
              echo " - [![VT](https://badges.cssnr.com/vt/id/$sha256) $filename](https://www.virustotal.com/gui/file/$sha256) â€” BAD âŒ" >> vt_report.txt
            else
              echo " - [![VT](https://badges.cssnr.com/vt/id/$sha256) $filename](https://www.virustotal.com/gui/file/$sha256)" >> vt_report.txt
            fi
          done

      - name: Update Release with Quick Report
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # <-- Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾
        run: |
          tag=$(cat release_tag.txt)
          gh release view "$tag" --json body -q .body > current_notes.txt
          cat vt_report.txt >> current_notes.txt
          gh release edit "$tag" --notes-file current_notes.txt

      - name: Done
        run: |
          tag=$(cat release_tag.txt)
          echo "VirusTotal quick scan finished and report added to release $tag"

